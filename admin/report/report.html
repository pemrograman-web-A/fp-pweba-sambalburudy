<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Penjualan - Admin Bu Rudy</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script>
        // Konfigurasi Tailwind CSS (sama dengan Dashboard)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        burudy: {
                            red: '#B91C1C',
                            gold: '#F59E0B',
                            dark: '#1F2937',
                            light: '#FEF2F2',
                            green: '#059669' 
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        };

        const API_REPORT_URL = '../report_api.php'; // Sesuaikan path jika file berada di folder berbeda!
        
        function formatRupiah(number) {
            return 'Rp ' + parseInt(number).toLocaleString('id-ID');
        }

        // READ/FILTER: Fungsi utama untuk memuat laporan
        async function loadReport() {
            const period = document.getElementById('period').value;
            const revenueEl = document.getElementById('total-revenue');
            const transactionEl = document.getElementById('total-transactions');
            const itemsEl = document.getElementById('total-items');
            const chartAreaEl = document.getElementById('chart-area');

            // Set loading state
            revenueEl.innerText = 'Memuat...';
            transactionEl.innerText = 'Memuat...';
            itemsEl.innerText = 'Memuat...';
            chartAreaEl.innerHTML = `<p class="text-center text-gray-500 py-12"><i class="fas fa-spinner fa-spin mr-2"></i> Memuat transaksi untuk periode ${period.replace('_', ' ')}...</p>`;

            try {
                // Panggil API dengan parameter periode
                const response = await fetch(`${API_REPORT_URL}?period=${period}`);
                if (!response.ok) throw new Error(`Gagal memuat data laporan. HTTP Status: ${response.status}`);
                
                const reportData = await response.json();

                // 1. Tampilkan Metrik Kunci
                revenueEl.innerText = formatRupiah(reportData.totalRevenue);
                transactionEl.innerText = reportData.totalTransactions;
                itemsEl.innerText = reportData.totalItems;
                
                // 2. Tampilkan Detail Transaksi (Tabel)
                let tableHtml = `<h3 class="font-bold text-lg mb-4 mt-8">Detail Transaksi (${reportData.period_info.start} s/d ${reportData.period_info.end})</h3>`;
                
                if (reportData.transactions && reportData.transactions.length > 0) {
                    tableHtml += `
                        <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah Barang</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Pendapatan</th>
                        </tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;
                    
                    reportData.transactions.forEach(t => {
                        tableHtml += `<tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm font-medium">${t.id}</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm">${t.date}</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm">${t.items}</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-right font-semibold text-burudy-red">${formatRupiah(t.amount)}</td>
                        </tr>`;
                    });

                    tableHtml += `</tbody></table></div>`;
                } else {
                    tableHtml += `<p class="text-center text-gray-500 mt-4 py-8 border border-dashed rounded-lg bg-gray-50">Tidak ada transaksi ditemukan dalam periode ini.</p>`;
                }
                
                chartAreaEl.innerHTML = tableHtml;

            } catch (error) {
                alert('ðŸ”´ Error saat memuat laporan. Pastikan report_api.php dan transactions.json tersedia. Detail: ' + error.message);
                revenueEl.innerText = 'N/A';
                transactionEl.innerText = 'N/A';
                itemsEl.innerText = 'N/A';
            }
        }
        
        // Panggil laporan saat halaman dimuat
        document.addEventListener('DOMContentLoaded', loadReport);
    </script>
</head>
<body class="font-sans text-burudy-dark bg-gray-100 antialiased">

    <nav class="bg-burudy-dark text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <span class="font-serif text-xl font-bold text-burudy-gold tracking-wide">Bu Rudy Admin</span>
                    <span class="ml-4 text-gray-400">/ Laporan Penjualan</span>
                </div>
                <a href="/admin/admin.html" class="bg-burudy-red text-white px-3 py-1 rounded-full text-sm font-medium hover:bg-red-800 transition">Dashboard</a>
            </div>
        </div>
    </nav>

    <main class="py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-serif font-bold text-burudy-dark mb-8">Laporan Penjualan dan Analisis</h1>
            
            <div class="flex flex-col md:flex-row gap-4 mb-8 bg-white p-6 rounded-xl shadow-md border-b border-gray-200">
                <div class="w-full md:w-1/4">
                    <label for="period" class="block text-sm font-medium text-gray-700">Pilih Periode Laporan:</label>
                    <select id="period" onchange="loadReport()" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:border-burudy-gold focus:ring focus:ring-burudy-gold/50">
                        <option value="7_days">7 Hari Terakhir</option>
                        <option value="this_month">Bulan Ini</option>
                        <option value="last_month">Bulan Lalu</option>
                        <option value="this_year">Tahun Ini</option>
                    </select>
                </div>
                <div class="md:pt-6 flex items-end">
                    <button onclick="loadReport()" class="bg-burudy-red text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-800 transition shadow-md"><i class="fas fa-sync-alt mr-2"></i> Muat Ulang Laporan</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-burudy-green">
                    <p class="text-sm font-medium text-gray-500 uppercase">Total Pendapatan Bersih</p>
                    <p class="text-3xl font-bold text-burudy-dark mt-1" id="total-revenue">Rp 0</p>
                    <p class="text-xs text-burudy-green mt-1">Dihitung berdasarkan transaksi yang difilter.</p>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-burudy-red">
                    <p class="text-sm font-medium text-gray-500 uppercase">Jumlah Transaksi</p>
                    <p class="text-3xl font-bold text-burudy-dark mt-1" id="total-transactions">0</p>
                    <p class="text-xs text-burudy-red mt-1">Total jumlah order.</p>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-burudy-gold">
                    <p class="text-sm font-medium text-gray-500 uppercase">Total Barang Terjual</p>
                    <p class="text-3xl font-bold text-burudy-dark mt-1" id="total-items">0</p>
                    <p class="text-xs text-gray-500 mt-1">Kuantitas produk yang terjual.</p>
                </div>

            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200" id="chart-area">
                <p class="text-center text-gray-400">Memuat data laporan...</p>
            </div>

        </div>
    </main>

    <footer class="bg-burudy-dark py-4 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm">&copy; 2025 Bu Rudy Admin Panel.</p>
        </div>
    </footer>
</body>
</html>